{% extends "base.html" %}
{% block title %}Available Properties{% endblock %}

{% block content %}

<div class="listings-container">

    <div class="header-row">
        <h1 class="listings-title">Available Properties</h1>


        {% if user.is_authenticated and user.profile.role == 'LANDLORD' %}
            <a href="{% url 'rentals:property_create' %}" class="btn-primary-add">
                + New Property
            </a>
        {% endif %}
    </div>

    {% if properties %}
    <div class="property-grid">

        {% for p in properties %}
        <div class="property-card">

            <!-- Image Slider -->
            <div class="property-image-wrapper slider" id="slider-{{ p.id }}">

                {% if p.images.exists %}
                    {% for img in p.images.all %}
                        <img src="{{ img.image.url }}"
                             class="slide {% if forloop.first %}active{% endif %}"
                             alt="{{ p.title }}">
                    {% endfor %}
                {% else %}
                    <img src="https://picsum.photos/600/400?blur=2"
                         class="slide active"
                         alt="No Image">
                {% endif %}

                {% if p.images.count > 1 %}
                    <!-- Arrows -->
                    <button class="slider-btn prev">❮</button>
                    <button class="slider-btn next">❯</button>

                    <!-- Dots -->
                    <div class="dots"></div>

                    <!-- Counter -->
                    <div class="image-counter">
                        <span class="counter-current">1</span> /
                        <span class="counter-total">{{ p.images.count }}</span>
                    </div>
                {% endif %}

            </div>

            <!-- Body -->
            <div class="property-info">

                <h3 class="property-title">{{ p.title }}</h3>
                <p class="address">{{ p.address }}</p>

                <div class="property-specs">

                    <div class="spec">
                        <svg class="spec-icon"><use href="#icon-bed"/></svg>
                        <span>{{ p.bedrooms }} Beds</span>
                    </div>

                    <div class="spec">
                        <svg class="spec-icon"><use href="#icon-bath"/></svg>
                        <span>{{ p.bathrooms }} Bath</span>
                    </div>

                    <div class="spec">
                        <svg class="spec-icon"><use href="#icon-area"/></svg>
                        <span>{{ p.sqft }} SqFt</span>
                    </div>
                </div>

                <p class="rent">${{ p.monthly_rent }}</p>

                <a href="{% url 'rentals:property_detail' p.pk %}" class="btn-view">
                    View Details
                </a>

            </div>
        </div>
        {% endfor %}

    </div>

    {% else %}
        <p class="text-muted empty-msg">No properties available.</p>
    {% endif %}
</div>


<!-- SVG Icons -->
<svg style="display:none;">
    <symbol id="icon-bed" viewBox="0 0 24 24">
        <path d="M2 10v10h2v-2h16v2h2V10H2zm2 4v-2h16v2H4zm3-8h10a3 3 0 013 3v1H4v-1a3 3 0 013-3z"/>
    </symbol>

    <symbol id="icon-bath" viewBox="0 0 24 24">
        <path d="M3 10v6a4 4 0 004 4h10a4 4 0 004-4v-6H3zm2 2h14v4a2 2 0 01-2 2H7a2 2 0 01-2-2v-4zm3-7a3 3 0 016 0v1h-2V5a1 1 0 10-2 0v1H8V5z"/>
    </symbol>

    <symbol id="icon-area" viewBox="0 0 24 24">
        <path d="M3 3h18v18H3V3zm2 2v14h14V5H5z"/>
    </symbol>
</svg>


<!-- Slider JS -->
<script>
document.querySelectorAll(".slider").forEach(slider => {
    const slides = slider.querySelectorAll(".slide");
    const prev = slider.querySelector(".prev");
    const next = slider.querySelector(".next");
    const dotsContainer = slider.querySelector(".dots");
    const counterCurrent = slider.querySelector(".counter-current");

    if (!slides.length) return;

    let index = 0;

    /* Create dots */
    if (dotsContainer) {
        slides.forEach((_, i) => {
            const dot = document.createElement("span");
            dot.classList.toggle("active-dot", i === 0);
            dotsContainer.appendChild(dot);

            dot.addEventListener("click", () => {
                index = i;
                updateSlider();
            });
        });
    }

    const dots = dotsContainer ? dotsContainer.querySelectorAll("span") : [];

    function updateSlider() {
        slides.forEach(s => s.classList.remove("active"));
        slides[index].classList.add("active");

        dots.forEach(d => d.classList.remove("active-dot"));
        dots[index]?.classList.add("active-dot");

        if (counterCurrent) counterCurrent.textContent = index + 1;
    }

    prev?.addEventListener("click", () => {
        index = (index === 0) ? slides.length - 1 : index - 1;
        updateSlider();
    });

    next?.addEventListener("click", () => {
        index = (index === slides.length - 1) ? 0 : index + 1;
        updateSlider();
    });

    setInterval(() => {
        index = (index + 1) % slides.length;
        updateSlider();
    }, 3500);
});
</script>

{% endblock %}
